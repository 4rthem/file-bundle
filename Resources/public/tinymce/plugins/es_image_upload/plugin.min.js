tinymce.PluginManager.add("arthem_image_upload", function (editor, t) {
    var token = editor.getParam("session_token"),
        path = editor.getParam("image_upload_path"),
        _window;


    function browse() {
        var $file = $('<input type="file" accept="image/jpeg,image/png,image/gif"/>');

        $file.fileupload({
            dataType: 'json',
            url: path,
            formData: {
                'file[_token]': token
            },
            paramName: 'file[file][file]'
        })
            .on('fileuploadadd', function (e, data) {
                data.submit();
                editor.setProgressState(true, 200);
            })
            .on('fileuploadprogress', function (e, data) {
                var progress = parseInt(data.loaded / data.total * 100, 10);
            })
            .on('fileuploaddone', function (e, data) {
                file = data.result.file;
                var image = new Image();
                image.onload = function () {
                    editor.selection.setContent(editor.dom.createHTML("img", {
                        src: file.url
                    }));
                    editor.setProgressState(false);
                };
                image.src = file.url;
            })
            .on('fileuploadfail', function (e, data) {
                editor.setProgressState(false);
                var r = data.response().jqXHR.responseJSON;
                if (r.errors) {
                    editor.windowManager.alert(r.errors.join('<br>'))
                }
            });
        $file.trigger('click');
    }

    editor.addButton("arthem_image_upload", {
        tooltip: "Upload an image",
        icon: "image",
        text: "Upload",
        onclick: function () {
            browse();
        }
    });
});
